<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">

  <!-- If for some reason you are using IE, use edge -->
  <meta http-equiv="X-UA-Compatible" content="IE=edge">

  <!-- So bootstrap isn't horrible, set the width -->
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/favicons/apple-touch-icon.png">
  <link rel="icon" type="image/png" href="/images/favicons/favicon-32x32.png" sizes="32x32">
  <link rel="icon" type="image/png" href="/images/favicons/favicon-16x16.png" sizes="16x16">
  <link rel="manifest" href="/images/favicons/manifest.json">
  <link rel="mask-icon" href="/images/favicons/safari-pinned-tab.svg" color="#5bbad5">
  <meta name="theme-color" content="#ffffff">

  <title>File System, Part 6: Memory mapped files and Shared memory</title>

  <!-- Reference a CDN so this is properly cached in the browser forever. Unless they clean out the
       Cache this will incur no load time. Ideally we should put a security checksum but that breaks
       Firefox development sometimes -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" crossorigin="anonymous">

  <!-- Asynchronously load the code style sheet because we want everything loaded as fast as possible
       Also tag with ?v=time to bust the cache of any browser so updates appear -->
  <link async rel="stylesheet" href="/css/code-style.css?v='2018-11-28 20:00:31 -0600'">

  <!-- Don't load async because this will make the page render faster, plus the file is small.
       Also do the same cache busting magic here -->
  <link rel="stylesheet" href="/css/main.css?v='2018-11-28 20:00:31 -0600'">

</head>

<body>
<!-- Always shows a header, even in smaller screens. -->
<nav class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">
        <div class="navbar-header">

            <!-- Navigation button as html so we don't have to resize images -->
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target=".navbar-collapse" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            </button>


            <!-- Inline tux for speed -->
            <a id="tuxlink"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAgAAAAJCAMAAAA4jZ0cAAAAM1BMVEX///8CAgQMDAwsLCw0NDSjbQCkbQC+vbzOkwDU1NTlrADqvADxtgD0vQD12wD+/vz+//yBSdYEAAAAAXRSTlMAQObYZgAAADFJREFUCB0FwQkCQDAQBLCsq6g1/v9aCVQBthUwX8BIgStZCpUvKXSSLs6eyd0Pdg5+JwkBVyC74QYAAAAASUVORK5CYII=" title="Tux" alt="Tux" style="margin-left: 1em; width: 24px; filter: drop-shadow(1px 1px 0 white) drop-shadow(1px -1px 0 white) drop-shadow(-1px 1px 0 white) drop-shadow(-1px -1px 0 white); margin-top: 1em;"/></a>

            <a class="navbar-brand navbar-link normal" href="/">CS 241: System Programming</a>
            <a class="navbar-brand navbar-link small" href="/">CS 241</a>
        </div>

        <div id="navbar" class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
            
            <li>
                <a class="navbar-link" href="/assignments.html">Assignments</a>
            </li>
            
            <li>
                <a class="navbar-link" href="/quiz_topics.html">Quizzes</a>
            </li>
            
            <li>
                <a class="navbar-link" href="/help.html">Help!</a>
            </li>
            
            <li>
                <a class="navbar-link" href="/schedule.html">Schedule</a>
            </li>
            
            <li>
                <a class="navbar-link" href="/honors.html">Honors</a>
            </li>
            
            <li>
                <a class="navbar-link" href="/staff.html">The Crew</a>
            </li>
            
            <li>
                <a class="navbar-link" href="/search.html">Search</a>
            </li>
            
            <li>
                <a class="navbar-link" href="/wikibook/home.html">Wikibook</a>
            </li>
            
            <li>
                <a class="navbar-link" href="/wikibook_project/Index.html">Wikibook Project</a>
            </li>
            
          </ul>
        </div>
        </div>
</nav>


<div class="container-fluid">
  <div class="row">
    <div class="col-md-2 col-sm-1 col-xs-0"></div>
    <div class="col-md-8 col-sm-10 col-xs-12">
      <div class="wrapper">
        <div class="pad"><div class="card">
          <div class="title">
            <div class="speaker-wrapper">
              <button onclick="speak()" class="speaker" alt="Read Page"></button>
            </div>
            <h1>
              File System, Part 6: Memory mapped files and Shared memory

              
                <a class="github-link hidden-xs" href="https://github.com/angrave/SystemProgramming/wiki/File-System,-Part-6:-Memory-mapped-files-and-Shared-memory">Edit on Github</a>
              
            </h1>
          </div>
          <div class="container-fluid"><div class="row"><div class="content col-sm-11 .col-sm-offset-1">
            
            
          </div></div></div>
        </div></div>
      </div>
      
      <div class="toc-wrapper">
<h4>Content</h4>
<ul class="toc">
<li><a id="toc_how-does-the-operating-system-load-my-process-and-libraries-into-memory" href="#how-does-the-operating-system-load-my-process-and-libraries-into-memory" class="fancy-link">How does the operating system load my process and libraries into memory?</a></li>
<li><a id="toc_how-do-i-map-a-file-into-memory" href="#how-do-i-map-a-file-into-memory" class="fancy-link">How do I map a file into memory?</a></li>
<li><a id="toc_difference-between-read--write-and-mmap" href="#difference-between-read--write-and-mmap" class="fancy-link">Difference between <code class="highlighter-rouge">read</code> + <code class="highlighter-rouge">write</code> and <code class="highlighter-rouge">mmap</code></a></li>
<li><a id="toc_what-are-the-advantages-of-memory-mapping-a-file" href="#what-are-the-advantages-of-memory-mapping-a-file" class="fancy-link">What are the advantages of memory mapping a file</a></li>
<li><a id="toc_how-do-i-share-memory-between-a-parent-and-child-process" href="#how-do-i-share-memory-between-a-parent-and-child-process" class="fancy-link">How do I share memory between a parent and child process?</a></li>
<li><a id="toc_can-i-use-shared-memory-for-ipc-" href="#can-i-use-shared-memory-for-ipc-" class="fancy-link">Can I use shared memory for IPC ?</a></li>
</ul>
</div>
      
      <div id="content">
          <div class="wrapper">

</div>
          <div class="wrapper">
<div class="pad"><div class="card">
<div class="title"><h2 id="how-does-the-operating-system-load-my-process-and-libraries-into-memory" class="title-text">How does the operating system load my process and libraries into memory?<a class="anchor title-text" href="#how-does-the-operating-system-load-my-process-and-libraries-into-memory">#</a>
</h2></div>




<div class="container-fluid"><div class="row"><div class="content col-sm-11 .col-sm-offset-1">
<p>It maps the executable and library file contents into the address space of the process.
If many programs only need read-access to the same file (e.g. /bin/bash, the C library) then the same physical memory can be shared between multiple processes.</p>
<p>The same mechanism can be used by programs to directly map files into memory.</p>
</div></div></div>
</div></div>
<div class="pad"><div class="card">
<div class="title"><h2 id="how-do-i-map-a-file-into-memory" class="title-text">How do I map a file into memory?<a class="anchor title-text" href="#how-do-i-map-a-file-into-memory">#</a>
</h2></div>











<div class="container-fluid"><div class="row"><div class="content col-sm-11 .col-sm-offset-1">
<p>A simple program to map a file into memory is shown below. The key points to notice are:</p>
<ul>
  <li>
<code class="highlighter-rouge"><a href="https://linux.die.net/man/3/mmap" class="fancy-link">mmap</a></code> requires a file descriptor, so we need to <code class="highlighter-rouge"><a href="https://linux.die.net/man/3/open" class="fancy-link">open</a></code> the file first</li>
  <li>
<code class="highlighter-rouge"><a href="https://linux.die.net/man/3/mmap" class="fancy-link">mmap</a></code> only works on <code class="highlighter-rouge"><a href="https://linux.die.net/man/3/lseek" class="fancy-link">lseek</a></code>able file descriptors, i.e. “true” files, not pipes or sockets</li>
  <li>We seek to our desired size and write one byte to ensure that the file is sufficient length (failing to do so causes your program to receive SIGBUS upon trying to access the file). <code class="highlighter-rouge"><a href="https://linux.die.net/man/3/ftruncate" class="fancy-link">ftruncate</a></code> would also work.</li>
  <li>When finished, we call <code class="highlighter-rouge"><a href="https://linux.die.net/man/3/munmap" class="fancy-link">munmap</a></code> to unmap the file from memory</li>
</ul>
<p>This example also shows the preprocessor constants “<strong>LINE</strong>” and “<strong>FILE</strong>” that hold the current line number and filename of the file currently being compiled.</p>
<pre><code class="language-C"><span class="cp">#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;sys/types.h&gt;
#include &lt;sys/stat.h&gt;
#include &lt;sys/mman.h&gt;
#include &lt;fcntl.h&gt;
#include &lt;unistd.h&gt;
#include &lt;errno.h&gt;
#include &lt;string.h&gt;
</span>
</code></pre>
<p>The contents of our binary file can be listed using hexdump</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ hexdump data
0000000 78 56 34 12 de c0 ad de 00 00 00 00 00 00 00 00
0000010 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
0000020 00 00 00 00 00 00 00 00 41   
</code></pre></div></div>
<p>The careful reader may notice that our integers were written in least-significant-byte format (because that is the endianness of the CPU) and that we allocated a file that is one byte too many!</p>
<p>The <code class="highlighter-rouge">PROT_READ | PROT_WRITE</code> options specify the virtual memory protection. The option <code class="highlighter-rouge">PROT_EXEC</code> (not used here) can be set to allow CPU execution of instructions in memory (e.g. this would be useful if you mapped an executable or library).</p>
</div></div></div>
</div></div>
<div class="pad"><div class="card">
<div class="title"><h2 id="difference-between-read--write-and-mmap" class="title-text">Difference between <code class="highlighter-rouge"><a href="https://linux.die.net/man/3/read" class="fancy-link">read</a></code> + <code class="highlighter-rouge"><a href="https://linux.die.net/man/3/write" class="fancy-link">write</a></code> and <code class="highlighter-rouge"><a href="https://linux.die.net/man/3/mmap" class="fancy-link">mmap</a></code><a class="anchor title-text" href="#difference-between-read--write-and-mmap">#</a>
</h2></div>







<div class="container-fluid"><div class="row"><div class="content col-sm-11 .col-sm-offset-1">
<p>On Linux, there are more similarities between these approaches than differences. In both cases, the file is actually loaded into the disk cache before reads or writes occur, and writes are first performed directly on pages in the disk cache rather than on the hard disk. The operating system will synchronize the disk cache with disk eventually; you can use <code class="highlighter-rouge"><a href="https://linux.die.net/man/3/sync" class="fancy-link">sync</a></code> (or its variants) to request that it do so immediately.</p>
<p>However, <code class="highlighter-rouge"><a href="https://linux.die.net/man/3/mmap" class="fancy-link">mmap</a></code> allows your process to directly access the physical memory stored in the page cache. It does this by mapping the process page table entries to the same page frames found in the disk cache. <code class="highlighter-rouge"><a href="https://linux.die.net/man/3/read" class="fancy-link">read</a></code>, on the other hand, must first load data from disk to the page cache, <em>and then copy over data</em> from the page cache to a user-space buffer (<code class="highlighter-rouge"><a href="https://linux.die.net/man/3/write" class="fancy-link">write</a></code> does the same, but in the opposite direction).</p>
<p>On the downside, creating this mapping between the process address space and the page cache requires the process to create many new page tables and leads to additional (minor) page faults upon first-time access of a file page.</p>
</div></div></div>
</div></div>
<div class="pad"><div class="card">
<div class="title"><h2 id="what-are-the-advantages-of-memory-mapping-a-file" class="title-text">What are the advantages of memory mapping a file<a class="anchor title-text" href="#what-are-the-advantages-of-memory-mapping-a-file">#</a>
</h2></div>






<div class="container-fluid"><div class="row"><div class="content col-sm-11 .col-sm-offset-1">
<p>For many applications the main advantages are:</p>
<ul>
  <li>Simplified coding - the file data is immediately available as if it were all in main memory. No need to parse the incoming data in chunks and store it in new memory structures like buffers.</li>
  <li>Sharing of files - memory mapped files are particularly convenient when the same data is shared between multiple processes.</li>
  <li>Lower memory pressure - when resources run tight, the kernel can easily drop data from the disk cache out of main memory and into backing disk storage (clean pages don’t even need to be written back to disk). On the other hand, loading large files into buffers will eventually force the kernel to store those pages (even clean ones) in swap space, which may run out.</li>
</ul>
<p>Note for simple sequential processing, memory mapped files are not necessarily faster than standard ‘stream-based’ approaches of <code class="highlighter-rouge"><a href="https://linux.die.net/man/3/read" class="fancy-link">read</a></code>, <code class="highlighter-rouge"><a href="https://linux.die.net/man/3/fscanf" class="fancy-link">fscanf</a></code>, etc., due primarily to minor page faults and the fact that loading data from disk to the page cache is a much tighter performance bottleneck than copying from one buffer to another.</p>
</div></div></div>
</div></div>
<div class="pad"><div class="card">
<div class="title"><h2 id="how-do-i-share-memory-between-a-parent-and-child-process" class="title-text">How do I share memory between a parent and child process?<a class="anchor title-text" href="#how-do-i-share-memory-between-a-parent-and-child-process">#</a>
</h2></div>





<div class="container-fluid"><div class="row"><div class="content col-sm-11 .col-sm-offset-1">
<p>Easy -  Use <code class="highlighter-rouge"><a href="https://linux.die.net/man/3/mmap" class="fancy-link">mmap</a></code> without a file - just specify the <code class="highlighter-rouge">MAP_ANONYMOUS</code> and <code class="highlighter-rouge">MAP_SHARED</code> options!</p>
<pre><code class="language-C"><span class="cp">#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;sys/types.h&gt;
#include &lt;sys/stat.h&gt;
#include &lt;sys/mman.h&gt; </span>
</code></pre>
</div></div></div>
</div></div>
<div class="pad"><div class="card">
<div class="title"><h2 id="can-i-use-shared-memory-for-ipc-" class="title-text">Can I use shared memory for IPC ?<a class="anchor title-text" href="#can-i-use-shared-memory-for-ipc-">#</a>
</h2></div>






<div class="container-fluid"><div class="row"><div class="content col-sm-11 .col-sm-offset-1">
<p>Yes! As a simple example you could reserve just a few bytes and change the value in shared memory when you want the child process to quit. Sharing anonymous memory is a very efficient form of inter-process communication because there is no copying, system call, or disk-access overhead - the two processes literally share the same <em>physical</em> frame of main memory.</p>
<p>On the other hand, shared memory, like multithreading, creates room for data races. Processes that share writable memory might need to use synchronization primitives like mutexes to prevent these from happening.</p>
<p><a href="/wikibook/file-system-part-7-scalable-and-reliable-filesystems.html#" class="fancy-link wiki-link">Go to File System: Part 7</a></p>
</div></div></div>
</div></div>
</div>
          
          <div class="wrapper">
</div>
      </div>
      <div class="col-md-2 col-sm-1 col-xs-0"></div>
    </div>
  </div>
  <script>
    var github_repo = "illinois-cs241/illinois-cs241.github.io";
    var github_path = "_wikibook/file-system-part-6-memory-mapped-files-and-shared-memory.md";
  </script>
  <!-- Mathjax takes a while to load so do a lazy load to so we can get accessibility -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML" crossorigin="anonymous"></script>

<!-- Again bust cache on the main.js file -->
<script src="/js/main.js?v='2018-11-28 20:00:31 -0600'"></script>

<script>
<footer class="">

<div class="container-fluid">
<div class="shadow"></div>

</div>

</footer>

</body>
</html>
